---
import MainLayout from '../../layouts/MainLayout.astro';
---

<MainLayout>
    <div class="flex justify-center items-center min-h-[calc(100vh-200px)]">
        <div class="max-w-md w-full p-8 bg-base-100 rounded-lg shadow-lg text-center">
            <div class="space-y-4">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-info/20 text-info mb-4">
                    <span class="loading loading-spinner loading-lg"></span>
                </div>
                <h2 class="text-2xl font-bold">Finalizing Authentication</h2>
                <p>Please wait while we complete the sign-in process...</p>
            </div>
        </div>
    </div>
</MainLayout>

<script>
    import { pb } from '../../lib/pocketbase';

    // This script runs when the page loads to handle the OAuth redirect
    document.addEventListener('DOMContentLoaded', () => {
        // Get the redirect destination from localStorage (or default to home)
        const redirectUrl = localStorage.getItem('redirectAfterAuth') || '/';

        // Clear the stored redirect URL
        localStorage.removeItem('redirectAfterAuth');

        // Check if the user is authenticated
        if (pb.authStore.isValid) {
            // User is authenticated, redirect to the destination
            window.location.href = redirectUrl;
        } else {
            // Something went wrong, redirect to login
            window.location.href = '/login?error=auth_failed';
        }
    });
</script>